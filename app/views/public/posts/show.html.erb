<h1><%= @post.title %></h1>
<p><%= @post.content %></p>
<p>投稿者: <%= @post.user.name %></p>
<%= render 'likes/like_button', post: @post %>

<h2>コメント</h2>
<% @post.comments.each do |comment| %>
  <div>
    <strong><%= comment.user.name %>:</strong>
    <span style="<%= 'background-color: #f2f2f2;' if comment.user == @post.user %>">
      <%= comment.posted_text %>
    </span>
    <% if comment.user == current_user %>
      <%= link_to '削除', public_comment_path(comment), method: :delete, data: { confirm: '本当に削除しますか？' } %>
    <% end %>
  </div>
  
  <!-- 返信一覧 -->
  <% if comment.replies.present? %>
    <%= link_to "返信を見る (#{comment.replies.count})", '#', class: 'show-replies-button' %>
    <div class="reply-list" style="display: none;">
      <% comment.replies.each do |reply| %>
        <div>
          <% if reply.user == current_user || reply.user == comment.user %>
            <strong><%= reply.user.name %>:</strong>
            <span style="<%= 'background-color: #f2f2f2;' if reply.user == @post.user %>">
              <%= reply.posted_text %>
            </span>
            <% if reply.user == current_user %>
              <%= link_to '削除', public_comment_reply_path(comment, reply), method: :delete, data: { confirm: '本当に削除しますか？' }, class: "reply-delete-link" %>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- 返信フォーム -->
  <%= link_to '返信する', '#', class: 'reply-button' %>
  <div class="reply-form" style="display: none;">
    <%= form_with(model: [comment, comment.replies.build], url: public_comment_replies_path(comment), local: true) do |form| %>
      <div class="field">
        <%= form.text_area :posted_text, rows: 2 %>
      </div>
      <div class="actions">
        <%= form.submit "Post Reply" %>
      </div>
    <% end %>
  </div>
<% end %>

<%= form_with(model: [@post, @post.comments.build], url: public_comments_path, local: true) do |form| %>
  <%= form.hidden_field :post_id, value: @post.id %>
  <div class="field">
    <%= form.label :posted_text, "コメントする" %>
    <%= form.text_area :posted_text, rows: 4 %>
  </div>
  <div class="actions">
    <%= form.submit "コメントする" %>
  </div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const replyButtons = document.querySelectorAll('.reply-button');
    replyButtons.forEach(function(replyButton) {
      replyButton.addEventListener('click', function(event) {
        event.preventDefault();
        const replyForm = replyButton.nextElementSibling;
        if (replyForm.style.display === 'none') {
          replyForm.style.display = 'block';
        } else {
          replyForm.style.display = 'none';
        }
      });
    });

    const showRepliesButtons = document.querySelectorAll('.show-replies-button');
    showRepliesButtons.forEach(function(showRepliesButton) {
      showRepliesButton.addEventListener('click', function(event) {
        event.preventDefault();
        const replyList = showRepliesButton.nextElementSibling;
        if (replyList.style.display === 'none') {
          replyList.style.display = 'block';
          showRepliesButton.textContent = '返信を非表示にする';
        } else {
          replyList.style.display = 'none';
          showRepliesButton.textContent = '返信を見る';
        }
      });
    });
  });
</script>
